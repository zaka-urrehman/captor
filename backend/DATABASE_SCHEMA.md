# CAPTOR Backend Database Schema

This document describes the database schema for the CAPTOR backend, implemented using SQLModel.

## Overview

The CAPTOR platform allows users to create AI agents that can collect structured data from end-users through chat interactions. The schema supports both Q&A style data collection and JSON-based structured data collection.

## Tables

### Core Tables

#### Users
SaaS accounts that create and manage agents.
- `id` (Primary Key)
- `name` - User's display name
- `email` - Unique email address
- `password_hash` - Hashed password for authentication
- `created_at`, `updated_at` - Timestamps

#### Agents
AI agents created by users to interact with customers.
- `id` (Primary Key)
- `user_id` (Foreign Key → users.id)
- `name` - Agent display name
- `description` - Agent description
- `system_prompt` - AI system instructions
- `user_instructions` - Instructions for end-users
- `webhook_url` - n8n webhook endpoint for integrations
- `created_at`, `updated_at` - Timestamps

#### Customers
End-users who interact with agent links.
- `id` (Primary Key)
- `agent_id` (Foreign Key → agents.id)
- `name` - Customer name (optional)
- `email` - Customer email (optional)
- `created_at` - Timestamp

#### Chat Sessions
Conversation instances between customers and agents.
- `id` (Primary Key)
- `agent_id` (Foreign Key → agents.id)
- `customer_id` (Foreign Key → customers.id)
- `started_at` - Session start time
- `ended_at` - Session end time (nullable)
- `created_at`, `updated_at` - Timestamps

#### Messages
Individual messages in chat conversations.
- `id` (Primary Key)
- `session_id` (Foreign Key → chat_sessions.id)
- `sender` - "customer" | "agent"
- `receiver` - Message recipient
- `content` - Message text
- `created_at` - Timestamp

#### Agent Outputs
Structured outputs generated by agents.
- `id` (Primary Key)
- `session_id` (Foreign Key → chat_sessions.id)
- `data` - JSON data generated by agent
- `created_at` - Timestamp

### Dynamic Data Collection Schema

#### Agent Data Schemas
Define data collection modes for agents.
- `id` (Primary Key)
- `agent_id` (Foreign Key → agents.id)
- `type` - "qa" (Question/Answer) | "json" (Structured JSON)
- `created_at` - Timestamp

#### Agent Data Fields
Fields/questions within data collection schemas.
- `id` (Primary Key)
- `schema_id` (Foreign Key → agent_data_schemas.id)
- `key` - Field name for JSON schemas
- `question` - Question text for Q&A schemas
- `data_type` - Data type (string, number, email, etc.)
- `required` - Boolean indicating if field is required
- `validation_rules` - JSON with validation rules and extra configuration
- `created_at` - Timestamp

#### Collected Data
Data collected during chat sessions.
- `id` (Primary Key)
- `session_id` (Foreign Key → chat_sessions.id)
- `schema_id` (Foreign Key → agent_data_schemas.id)
- `responses` - JSON with collected data:
  - For JSON mode: `{"email": "user@example.com", "budget": "5000"}`
  - For Q&A mode: `{"q1": "answer1", "q2": "answer2"}`
- `created_at` - Timestamp

## Relationships

- Users have many Agents
- Agents belong to Users and have many Customers, Chat Sessions, and Data Schemas
- Customers belong to Agents and have many Chat Sessions
- Chat Sessions belong to Agents and Customers, have many Messages, Agent Outputs, and Collected Data
- Messages belong to Chat Sessions
- Agent Outputs belong to Chat Sessions
- Data Schemas belong to Agents and have many Data Fields and Collected Data
- Data Fields belong to Data Schemas
- Collected Data belongs to Chat Sessions and Data Schemas

## File Structure

```
src/
├── core/
│   ├── __init__.py
│   └── config.py              # Application configuration
├── database/
│   ├── __init__.py
│   └── connection.py          # Database connection and session management
├── models/
│   ├── __init__.py           # Model exports
│   ├── base.py               # Base model classes
│   ├── user.py               # User models
│   ├── agent.py              # Agent models
│   ├── customer.py           # Customer models
│   ├── chat.py               # Chat session and message models
│   └── data_schema.py        # Dynamic data collection models
└── main.py                   # FastAPI application
```

## Usage

1. **Install dependencies**: The required packages are defined in `pyproject.toml`
2. **Set up environment**: Copy `.env.example` to `.env` and configure your database URL
3. **Database setup**: Tables will be created automatically on application startup
4. **Import models**: All models are available from `src.models`

## Next Steps

- Set up database connection with PostgreSQL
- Implement authentication endpoints
- Create CRUD operations for each model
- Add API endpoints for agent interactions
- Implement webhook integrations
